{"version":3,"sources":["server.ts"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["import { Logger, ValidationPipe } from \"@nestjs/common\";\nimport { INestApplication } from \"@nestjs/common/interfaces/nest-application.interface\";\nimport { FastifyAdapter } from \"@nestjs/core\";\nimport { DocumentBuilder, SwaggerModule } from \"@nestjs/swagger\";\nimport { NotaddFactory } from \"@notadd/core\";\nimport { Configuration } from \"@notadd/core/loaders\";\nimport { LogService } from \"@notadd/logger/services\";\nimport * as express from \"express\";\nimport * as ip from \"ip\";\nimport \"reflect-metadata\";\nimport * as serveStatic from \"serve-static\";\n\nimport { ApplicationModule } from \"./modules\";\n\nexport class ServerStarter {\n    /**\n     * @type { INestApplication }\n     */\n    protected instance: INestApplication;\n\n    /**\n     * @type { Logger }\n     */\n    protected logger = new Logger(\"NotaddFactory\", true);\n\n    public check() {\n        let result = true;\n        if (!Configuration.existsApplicationConfiguration()) {\n            this.logger.error(\"Application configuration do not exists!\");\n            this.logger.warn(\"Your version of Notadd has expired. Application aborted!\");\n            result = false;\n        }\n        if (!Configuration.existsDatabaseConfiguration()) {\n            this.logger.error(\"Database configuration do not exists!\");\n            this.logger.warn(\"Please usg command: [yarn run:install] to finish installation. Application aborted!\");\n            result = false;\n        }\n        if (!Configuration.existsServerConfiguration()) {\n            this.logger.error(\"Your version of Notadd has expired. Application aborted!\");\n            result = false;\n        }\n        if (!Configuration.existsSwaggerConfiguration()) {\n            this.logger.error(\"Your version of Notadd has expired. Application aborted!\");\n            result = false;\n        }\n        if (!result) {\n            this.logger.error(\"Application environmental detection with error!\");\n            process.exit(1);\n        }\n    }\n\n    async start() {\n        this.check();\n\n        const graphqlConfiguration = Configuration.loadGraphqlConfiguration();\n        const serverConfiguration = Configuration.loadServerConfiguration();\n\n        let index = process.argv.indexOf(\"--port\");\n        const port = index > -1\n            ? parseInt(process.argv[index + 1])\n            : serverConfiguration.http.port ? serverConfiguration.http.port : 3000;\n        index = process.argv.indexOf(\"--host\");\n        const host = index > -1\n            ?\n            process.argv[index + 1]\n            :\n            serverConfiguration.http.host\n                ? (\n                    serverConfiguration.http.host === \"*\"\n                        ? ip.address()\n                        : serverConfiguration.http.host\n                )\n                :\n                ip.address();\n        const address = `http://${host}:${port}`;\n\n        let application: INestApplication;\n        if (serverConfiguration.adapter === \"fastify\") {\n            const adapter = new FastifyAdapter();\n\n            application = await NotaddFactory.startWithFastify(ApplicationModule, adapter, {\n                bodyParser: true,\n                cors: true,\n                logger: LogService,\n            });\n            application.use(\"/\", serveStatic(`${process.cwd()}/public`));\n        } else {\n            application = await NotaddFactory.startWithExpress(ApplicationModule, {\n                bodyParser: true,\n                cors: true,\n                logger: LogService,\n            });\n            application.use(express.static(process.cwd() + \"/public/\"));\n        }\n        application.useGlobalPipes(new ValidationPipe());\n\n        const swaggerConfiguration = Configuration.loadSwaggerConfiguration();\n\n        if (serverConfiguration.adapter !== \"fastify\" && swaggerConfiguration.enable) {\n            const options = new DocumentBuilder()\n                .setTitle(\"Notadd\")\n                .setDescription(\"API document for Notadd.\")\n                .setVersion(\"2.0\")\n                .addBearerAuth()\n                .build();\n\n            const document = SwaggerModule.createDocument(application, options);\n\n            SwaggerModule.setup(`/${swaggerConfiguration.endpoint}`, application, document);\n        }\n\n        const callback = () => {\n            if (graphqlConfiguration.ide.enable) {\n                this.logger.log(`Graphql IDE Server on: ${address}/graphiql`);\n            }\n\n            if (serverConfiguration.adapter !== \"fastify\" && swaggerConfiguration.enable) {\n                this.logger.log(`Swagger Server on: ${address}/${swaggerConfiguration.endpoint}`);\n            }\n\n            this.logger.log(`Server on: ${address}`);\n        };\n\n        index = process.argv.indexOf(\"--host\");\n\n        if (index > -1) {\n            await application.listen(port, process.argv[index + 1], callback);\n        } else if (serverConfiguration.http.host && serverConfiguration.http.host !== \"*\") {\n            await application.listen(port, serverConfiguration.http.host, callback);\n        } else {\n            await application.listen(port, \"0.0.0.0\", callback);\n        }\n    }\n}\n"]}